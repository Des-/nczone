{# init some local variables #}
{% set can_manage = false %}
{% if not match.winner %}
  {% if CURRENT_PLAYER.CAN.MANAGE_OWN_MATCH %}
    {% for player in match.players.team1 %}
      {% if player.user_id == CURRENT_PLAYER.ID %}
        {% set can_manage = true %}
      {% endif %}
    {% endfor %}
    {% for player in match.players.team2 %}
      {% if player.user_id == CURRENT_PLAYER.ID %}
        {% set can_manage = true %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}
{% set bet_perc_1 = (match.bets.team1|length * 100 / (match.bets.team1|length + match.bets.team2|length))|round %}
{% set bet_perc_2 = 100 - bet_perc_1 %}

{# start outputting the match #}
<div class="zone-match">
  <div class="zone-match-title">{{ lang('NCZONE_MATCH_MATCH') }} #{{ match.id }}</div>
  <dl class="zone-match-data">
    {% if match.winner %}
      <dt>{{ lang('NCZONE_MATCH_WINNER') }}</dt>
      <dd>{{ match.winner }}</dd>
    {% endif %}

    <dt>{{ lang('NCZONE_MATCH_DRAWER') }}</dt>
    <dd>{{ match.drawer.name }}</dd>

    {% if match.winner %}
      <dt>{{ lang('NCZONE_MATCH_RESULT_POSTER') }}</dt>
      <dd>{{ match.result_poster.name }}</dd>
    {% endif %}

    <dt>{{ lang('NCZONE_MATCH_MAP') }}</dt>
    <dd>{{ match.map.title }}</dd>

    <dt>{{ lang('NCZONE_MATCH_CIVS') }}</dt>
    <dd>
      {% if match.civs.both %}
        <div>{{ lang('NCZONE_MATCH_CIVS_BOTH') }}
          : {% include 'zone/partial/civ_csv.html' with { civs: match.civs.both } %}</div>
      {% endif %}
      {% if match.civs.team1 %}
        <div>{{ lang('NCZONE_MATCH_CIVS_TEAM1') }}
          : {% include 'zone/partial/civ_csv.html' with { civs: match.civs.team1 } %}</div>
      {% endif %}
      {% if match.civs.team2 %}
        <div>{{ lang('NCZONE_MATCH_CIVS_TEAM2') }}
          : {% include 'zone/partial/civ_csv.html' with { civs: match.civs.team2 } %}</div>
      {% endif %}
    </dd>

    {% if match.winner %}
      <dt>{{ lang('NCZONE_MATCH_LENGTH') }}</dt>
      {# todo: calc... #}
      <dd>{{ match.timestampEnd - match.timestampStart }}</dd>
    {% else %}
      <dt>{{ lang('NCZONE_MATCH_TIME_SINCE_DRAW') }}</dt>
      <dd>{{ match.timestampStart }} {# todo init a timer #}</dd>
    {% endif %}

  </dl>
  <div class="zone-match-title">{{ lang('NCZONE_MATCH_TEAMS') }}:</div>
  <div class="zone-match-team-table">
    <div class="zone-match-team-1">

      {# todo: extract bets and team into own templates to reduce duplicate code #}
      <div class="zone-match-bets">
        <div class="zone-match-bets-percentage">{{ bet_perc_1 }}</div>
        <div class="zone-match-bets-overlay">
          <div class="zone-match-bets-title">{{ lang('NCZONE_MATCH_HAVE_BET') }}</div>
          <ul class="zone-match-betters">
            {% for bet in match.bets.team1 %}
              <li>{{ bet.user.name }} ({{ bet.timestamp }})</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="zone-match-team">
        {% set total_rating = 0 %}
        {% for player in match.players.team1 %}
          {% set total_rating = total_rating + player.rating %}
        {% endfor %}
        <dl>
          <dt>{{ lang('NCZONE_MATCH_TEAM1') }}</dt>
          <dd>({{ total_rating }})</dd>
          {% for player in match.players.team1 %}
            {# todo: explicit +- on rating change, classes to make it colored... #}
            <dt>{{ player.name }}{% if match.winner %}({{ player.rating_change }}){% endif %}</dt>
            <dd>({{ player.rating }})</dd>
          {% endfor %}
        </dl>
      </div>

    </div>
    <div class="zone-match-vs">
      {{ lang('NCZONE_MATCH_VS') }}
    </div>
    <div class="zone-match-team-2">

      {# todo: extract bets and team into own templates to reduce duplicate code #}
      <div class="zone-match-bets">
        <div class="zone-match-bets-percentage">{{ bet_perc_2 }}</div>
        <div class="zone-match-bets-overlay">
          <div class="zone-match-bets-title">{{ lang('NCZONE_MATCH_HAVE_BET') }}</div>
          <ul class="zone-match-betters">
            {% for bet in match.bets.team2 %}
              <li>{{ bet.user.name }} ({{ bet.timestamp }})</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="zone-match-team">
        {% set total_rating = 0 %}
        {% for player in match.players.team2 %}
          {% set total_rating = total_rating + player.rating %}
        {% endfor %}
        <dl>
          <dt>{{ lang('NCZONE_MATCH_TEAM2') }}</dt>
          <dd>({{ total_rating }})</dd>
          {% for player in match.players.team2 %}
            {# todo: explicit +- on rating change, classes to make it colored... #}
            <dt>{{ player.name }}{% if match.winner %}({{ player.rating_change }}){% endif %}</dt>
            <dd>({{ player.rating }})</dd>
          {% endfor %}
        </dl>
      </div>

    </div>
  </div>
  {% if can_manage %}
    <div class="zone-match-post-result-form">
      {{ lang('NCZONE_MATCH_RESULT') }}
      <select>
        <option value="">{{ lang('NCZONE_MATCH_POST_RESULT') }}</option>
        <option value="">{{ lang('NCZONE_MATCH_POST_WIN_TEAM1') }}</option>
        <option value="">{{ lang('NCZONE_MATCH_POST_WIN_TEAM2') }}</option>
        <option value="">{{ lang('NCZONE_MATCH_POST_DRAW') }}</option>
        <option value="">{{ lang('NCZONE_MATCH_POST_OW') }}</option>
      </select>
    </div>
  {% endif %}
</div>
